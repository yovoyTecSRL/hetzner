<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORBIX Ae.N.K.I - Sistema de Defensa IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 25%, #16213e 50%, #1a1a2e 75%, #0a0a0a 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Efectos de part√≠culas de fondo */
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #ffd700;
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.5; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .header {
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, #ffd700, transparent);
            animation: rotate 4s linear infinite;
            opacity: 0.1;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Panel del Avatar Ae.N.K.I */
        .avatar-panel {
            background: rgba(26, 26, 46, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 2px solid #ffd700;
            position: relative;
            overflow: hidden;
        }

        .avatar-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .avatar {
            width: 300px;
            height: 400px;
            border-radius: 20px;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: glow 3s ease-in-out infinite alternate;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8);
        }

        .avatar.talking {
            animation: talk 0.5s ease-in-out infinite;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            100% { box-shadow: 0 0 50px rgba(255, 215, 0, 0.8); }
        }

        @keyframes talk {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* TalkingHead 3D Avatar Container */
        .talking-head-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1), transparent);
        }

        #talkinghead-canvas {
            width: 100%;
            height: 100%;
            border-radius: 20px;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            pointer-events: none;
            border-radius: 20px;
        }

        .avatar-status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
        }

        /* Avatar Container States */
        .avatar-container.loaded .avatar-image {
            opacity: 1;
            transform: scale(1);
        }

        .avatar-container.talking .avatar-image {
            filter: drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)) brightness(1.2);
        }

        .avatar-container.listening .avatar-image {
            filter: drop-shadow(0 0 25px rgba(0, 255, 0, 0.7)) brightness(1.1);
        }

        .avatar-container.happy .avatar-image {
            filter: drop-shadow(0 0 35px rgba(255, 255, 0, 0.9)) brightness(1.3);
        }

        .avatar-container.thinking .avatar-image {
            filter: drop-shadow(0 0 20px rgba(0, 150, 255, 0.6)) brightness(1.1);
        }

        .avatar-container.alert .avatar-image {
            filter: drop-shadow(0 0 40px rgba(255, 0, 0, 0.8)) brightness(1.4);
        }

        .avatar-container.processing .avatar-image {
            filter: drop-shadow(0 0 25px rgba(255, 0, 255, 0.7)) brightness(1.2);
        }

        .avatar-container.scanning .avatar-image {
            filter: drop-shadow(0 0 30px rgba(255, 165, 0, 0.8)) brightness(1.2);
        }

        /* Avatar Animations */
        @keyframes avatarBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes avatarTalk {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(1deg); }
            50% { transform: scale(1.03) rotate(0deg); }
            75% { transform: scale(1.05) rotate(-1deg); }
        }

        @keyframes avatarGlow {
            0%, 100% { filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5)); }
            50% { filter: drop-shadow(0 0 40px rgba(255, 215, 0, 0.8)); }
        }

        @keyframes avatarListen {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes avatarPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes avatarHappy {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(3deg); }
            50% { transform: scale(1.05) rotate(0deg); }
            75% { transform: scale(1.1) rotate(-3deg); }
        }

        @keyframes avatarBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        @keyframes avatarThink {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
        }

        @keyframes avatarAlert {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @keyframes avatarProcess {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes avatarScan {
            0%, 100% { transform: translateX(0px); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(0px); }
            75% { transform: translateX(5px); }
        }

        /* Particle Effects */
        .talking-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            animation: talkingParticle 2s ease-out infinite;
            pointer-events: none;
        }

        @keyframes talkingParticle {
            0% { opacity: 1; transform: scale(1) translateY(0px); }
            100% { opacity: 0; transform: scale(0.5) translateY(-30px); }
        }

        .listening-wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            animation: listeningWave 2s ease-out infinite;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        @keyframes listeningWave {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .happy-particle {
            position: absolute;
            font-size: 16px;
            animation: happyParticle 3s ease-out infinite;
            pointer-events: none;
        }

        @keyframes happyParticle {
            0% { opacity: 1; transform: scale(1) translateY(0px) rotate(0deg); }
            100% { opacity: 0; transform: scale(0.5) translateY(-50px) rotate(360deg); }
        }

        .thinking-bubble {
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 24px;
            animation: thinkingBubble 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes thinkingBubble {
            0%, 100% { transform: scale(1) translateY(0px); opacity: 0.8; }
            50% { transform: scale(1.2) translateY(-10px); opacity: 1; }
        }

        .alert-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 0, 0, 0.6);
            border-radius: 50%;
            animation: alertRing 1s ease-out infinite;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        @keyframes alertRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }

        .processing-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top: 3px solid rgba(255, 0, 255, 0.8);
            border-radius: 50%;
            animation: processingRing 1s linear infinite;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        @keyframes processingRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scanning-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 165, 0, 0.8), transparent);
            animation: scanningLine 1s ease-in-out infinite;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        @keyframes scanningLine {
            0% { transform: translateY(0px); }
            100% { transform: translateY(100%); }
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #1a1a2e;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Status Display */
        .status-display {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            height: 300px;
            overflow-y: auto;
        }

        .status-line {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Voice Controls */
        .voice-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .voice-btn {
            padding: 15px;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .voice-btn.listening {
            background: #ff4444;
            color: white;
            animation: pulse 1s infinite;
        }

        .voice-btn.idle {
            background: #ffd700;
            color: #1a1a2e;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Avatar Editor Panel */
        .avatar-editor {
            position: fixed;
            top: 20px;
            right: -350px;
            width: 320px;
            height: calc(100vh - 40px);
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px 0 0 20px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            border: 2px solid #ffd700;
        }

        .avatar-editor.open {
            right: 0;
        }

        .avatar-editor-toggle {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 100px;
            background: #ffd700;
            border-radius: 20px 0 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1a1a2e;
            font-size: 18px;
            font-weight: bold;
            writing-mode: vertical-lr;
        }

        .avatar-editor-toggle:hover {
            background: #ff6b35;
            transform: translateY(-50%) translateX(-5px);
        }

        .avatar-editor-content {
            padding: 20px;
            height: 100%;
        }

        .avatar-editor h3 {
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
        }

        .editor-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .editor-section h4 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            color: #ccc;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ffd700;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
        }

        .control-group input[type="range"] {
            background: transparent;
        }

        .control-group input[type="color"] {
            height: 40px;
            cursor: pointer;
        }

        .btn-editor {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-editor:hover {
            background: #ff6b35;
            transform: translateY(-2px);
        }

        .btn-editor.secondary {
            background: #007bff;
            color: white;
        }

        .animation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .animation-btn {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .animation-btn:hover {
            background: #ffd700;
            color: #1a1a2e;
        }

        .preset-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .preset-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255,215,0,0.5);
        }

        /* Sentinel Network Scanner Panel */
        .sentinel-panel {
            background: rgba(26, 26, 46, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 2px solid #ff6b35;
        }

        .sentinel-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .sentinel-header h2 {
            color: #ff6b35;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .sentinel-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,107,53,0.1);
            border-radius: 10px;
            border: 1px solid #ff6b35;
        }

        .status-item {
            text-align: center;
        }

        .status-item .label {
            color: #ccc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .status-item .value {
            color: #ff6b35;
            font-size: 1.4em;
            font-weight: bold;
        }

        .network-devices {
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border-left: 4px solid #ffd700;
            transition: all 0.3s ease;
        }

        .device-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .device-item.suspicious {
            border-left-color: #ff4444;
            background: rgba(255,68,68,0.1);
        }

        .device-info {
            display: flex;
            flex-direction: column;
        }

        .device-ip {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .device-details {
            color: #ccc;
            font-size: 0.8em;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00ff00;
        }

        .device-status-icon.suspicious {
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .scan-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .scan-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scan-btn.primary {
            background: linear-gradient(45deg, #ff6b35, #ff4444);
            color: white;
        }

        .scan-btn.secondary {
            background: rgba(255,107,53,0.2);
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }

        .scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .scan-progress {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b35, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            color: #ccc;
            text-align: center;
            font-size: 0.9em;
        }

        .threat-alert {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            animation: pulse 2s infinite;
        }

        .threat-alert.show {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .avatar-editor {
                width: 280px;
                right: -280px;
            }
            
            .avatar-editor-toggle {
                left: -35px;
                width: 30px;
                height: 80px;
                font-size: 14px;
            }
            
            .sentinel-status {
                flex-direction: column;
                gap: 15px;
            }
            
            .scan-controls {
                flex-direction: column;
            }
            
            .device-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Part√≠culas de fondo -->
    <div id="particles"></div>

    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è ORBIX Ae.N.K.I</h1>
            <p class="subtitle">Sistema de Defensa de Inteligencia Artificial Avanzada</p>
        </div>

        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <h2 style="color: #ffd700; margin-bottom: 20px; text-align: center;">üéõÔ∏è Panel de Control</h2>
                
                <div class="control-grid">
                    <div class="control-card">
                        <h3>üîç Explorador Servidor</h3>
                        <p>Navegar por el sistema de archivos</p>
                        <button class="btn btn-primary" onclick="exploreServer()">Explorar</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>‚ö° Estado del Sistema</h3>
                        <p>Verificar salud del servidor</p>
                        <button class="btn btn-success" onclick="checkSystemHealth()">Verificar</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>üîí Seguridad</h3>
                        <p>An√°lisis de seguridad completo</p>
                        <button class="btn btn-warning" onclick="runSecurityScan()">Escanear</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>üìä Monitoreo</h3>
                        <p>Estad√≠sticas en tiempo real</p>
                        <button class="btn btn-primary" onclick="showStats()">Ver Stats</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>üîÑ Sincronizaci√≥n</h3>
                        <p>Sync con repositorio local</p>
                        <button class="btn btn-success" onclick="syncWithLocal()">Sincronizar</button>
                    </div>
                    
                    <div class="control-card">
                        <h3>üö® Alertas</h3>
                        <p>Sistema de notificaciones</p>
                        <button class="btn btn-danger" onclick="showAlerts()">Ver Alertas</button>
                    </div>
                </div>

                <div class="status-display" id="statusDisplay">
                    <div class="status-line">üöÄ Sistema ORBIX Ae.N.K.I iniciado...</div>
                    <div class="status-line">üîó Conectando con servidor Hetzner (178.156.182.125)...</div>
                    <div class="status-line">‚úÖ Conexi√≥n establecida</div>
                    <div class="status-line">üõ°Ô∏è M√≥dulos de seguridad activados</div>
                    <div class="status-line">üì° Sentinel en l√≠nea</div>
                    <div class="status-line">üß† Ae.N.K.I listo para interactuar</div>
                </div>
            </div>

            <!-- Avatar Panel -->
            <div class="avatar-panel">
                <div class="avatar-container" id="avatarContainer">
                    <div class="avatar" onclick="toggleVoice()">
                        <div class="talking-head-container">
                            <canvas id="talkinghead-canvas"></canvas>
                            <div class="avatar-overlay"></div>
                            <div class="avatar-status-indicator"></div>
                        </div>
                        <img id="avatarImage" src="https://sistemasorbix.com/assets/img/aenki-avatar.png" alt="Ae.N.K.I Avatar" class="avatar-image">
                    </div>
                    <div class="avatar-name">Ae.N.K.I</div>
                    <div class="avatar-status" id="avatarStatus">üü¢ En l√≠nea - Listo para asistir</div>
                </div>

                <div class="voice-controls">
                    <button class="voice-btn idle" id="voiceBtn" onclick="toggleVoice()">üé§</button>
                    <button class="voice-btn idle" onclick="speakWelcome()">üîä</button>
                    <button class="voice-btn idle" onclick="muteToggle()">üîá</button>
                </div>

                <div class="chat-interface">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message aenki">
                            üëã ¬°Hola! Soy Ae.N.K.I, tu asistente de inteligencia artificial. Estoy aqu√≠ para ayudarte con el sistema ORBIX y el servidor Hetzner. ¬øEn qu√© puedo asistirte?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Escribe tu mensaje o pregunta..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sentinel Network Scanner Panel -->
    <div class="sentinel-panel">
        <div class="sentinel-header">
            <h2>üõ°Ô∏è SENTINEL - Network Scanner</h2>
            <p style="color: #ccc;">Sistema de Escaneo de Red y Detecci√≥n de Amenazas</p>
        </div>

        <div class="sentinel-status">
            <div class="status-item">
                <div class="label">Estado</div>
                <div class="value" id="sentinelStatus">LISTO</div>
            </div>
            <div class="status-item">
                <div class="label">Dispositivos</div>
                <div class="value" id="deviceCount">0</div>
            </div>
            <div class="status-item">
                <div class="label">Amenazas</div>
                <div class="value" id="threatCount">0</div>
            </div>
            <div class="status-item">
                <div class="label">√öltimo Escaneo</div>
                <div class="value" id="lastScan">Nunca</div>
            </div>
        </div>

        <div class="scan-controls">
            <button class="scan-btn primary" onclick="startNetworkScan()">
                <span>üîç</span> Escanear Red
            </button>
            <button class="scan-btn secondary" onclick="startAdvancedScan()">
                <span>‚ö°</span> Escaneo Avanzado
            </button>
            <button class="scan-btn secondary" onclick="startContinuousMode()">
                <span>üîÑ</span> Modo Continuo
            </button>
            <button class="scan-btn secondary" onclick="exportScanResults()">
                <span>üìä</span> Exportar
            </button>
        </div>

        <div class="scan-progress" id="scanProgress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Iniciando escaneo...</div>
        </div>

        <div class="threat-alert" id="threatAlert">
            <strong>‚ö†Ô∏è ALERTA DE AMENAZA DETECTADA</strong>
            <p id="threatMessage">Dispositivo sospechoso detectado en la red</p>
        </div>

        <div class="network-devices" id="networkDevices">
            <h3 style="color: #ff6b35; margin-bottom: 15px;">üì° Dispositivos Detectados</h3>
            <div id="deviceList">
                <!-- Los dispositivos se mostrar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- TalkingHead 3D Library -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        // Variables globales para Sentinel
        let isScanning = false;
        let continuousMode = false;
        let scanResults = [];
        let threatLevel = 0;
        let scanProgress = 0;
        let scanInterval;
        let continuousInterval;

        // Simulated network devices database
        const deviceDatabase = [
            { ip: '192.168.1.1', mac: '00:11:22:33:44:55', vendor: 'Cisco', os: 'IOS', hostname: 'Router-Main', type: 'router', threat: 0 },
            { ip: '192.168.1.2', mac: '00:11:22:33:44:56', vendor: 'Netgear', os: 'Linux', hostname: 'AP-Guest', type: 'access_point', threat: 0 },
            { ip: '192.168.1.10', mac: '00:11:22:33:44:57', vendor: 'Dell', os: 'Windows 11', hostname: 'PC-Admin', type: 'desktop', threat: 0 },
            { ip: '192.168.1.11', mac: '00:11:22:33:44:58', vendor: 'Apple', os: 'macOS', hostname: 'MacBook-Dev', type: 'laptop', threat: 0 },
            { ip: '192.168.1.25', mac: '00:11:22:33:44:59', vendor: 'Samsung', os: 'Android', hostname: 'Galaxy-S23', type: 'mobile', threat: 0 },
            { ip: '192.168.1.35', mac: '00:11:22:33:44:60', vendor: 'Unknown', os: 'HDPTAndroid', hostname: 'SuspiciousDevice', type: 'unknown', threat: 8 },
            { ip: '192.168.1.50', mac: '00:11:22:33:44:61', vendor: 'Raspberry Pi', os: 'Linux', hostname: 'IoT-Sensor', type: 'iot', threat: 0 },
            { ip: '192.168.1.100', mac: '00:11:22:33:44:62', vendor: 'HP', os: 'Windows 10', hostname: 'Workstation-01', type: 'desktop', threat: 0 },
            { ip: '192.168.1.200', mac: '00:11:22:33:44:63', vendor: 'Synology', os: 'DSM', hostname: 'NAS-Server', type: 'server', threat: 0 },
            { ip: '192.168.1.99', mac: '00:11:22:33:44:64', vendor: 'Unknown', os: 'Custom', hostname: 'Intruder-Device', type: 'unknown', threat: 9 }
        ];

        // Sentinel Network Scanner Functions
        function startNetworkScan() {
            if (isScanning) return;
            
            isScanning = true;
            scanResults = [];
            scanProgress = 0;
            
            updateSentinelStatus('ESCANEANDO');
            document.getElementById('scanProgress').style.display = 'block';
            document.getElementById('threatAlert').classList.remove('show');
            
            // Simulate network scanning
            scanInterval = setInterval(() => {
                scanProgress += Math.random() * 15 + 5;
                
                if (scanProgress >= 100) {
                    scanProgress = 100;
                    completeScan();
                } else {
                    updateScanProgress(scanProgress, `Escaneando rango IP... ${Math.floor(scanProgress)}%`);
                    
                    // Randomly discover devices during scan
                    if (Math.random() < 0.3) {
                        const device = deviceDatabase[Math.floor(Math.random() * deviceDatabase.length)];
                        if (!scanResults.find(d => d.ip === device.ip)) {
                            scanResults.push({...device});
                            updateDeviceList();
                        }
                    }
                }
            }, 500);
        }

        function startAdvancedScan() {
            if (isScanning) return;
            
            isScanning = true;
            scanResults = [];
            scanProgress = 0;
            
            updateSentinelStatus('ESCANEO AVANZADO');
            document.getElementById('scanProgress').style.display = 'block';
            document.getElementById('threatAlert').classList.remove('show');
            
            // Advanced scan with port scanning and OS detection
            scanInterval = setInterval(() => {
                scanProgress += Math.random() * 8 + 3;
                
                if (scanProgress >= 100) {
                    scanProgress = 100;
                    completeAdvancedScan();
                } else {
                    const phases = ['Descubrimiento de hosts', 'Escaneo de puertos', 'Detecci√≥n de OS', 'An√°lisis de vulnerabilidades'];
                    const currentPhase = phases[Math.floor(scanProgress / 25)];
                    updateScanProgress(scanProgress, `${currentPhase}... ${Math.floor(scanProgress)}%`);
                    
                    // Discover devices with more detailed info
                    if (Math.random() < 0.4) {
                        const device = deviceDatabase[Math.floor(Math.random() * deviceDatabase.length)];
                        if (!scanResults.find(d => d.ip === device.ip)) {
                            // Enhanced device info for advanced scan
                            const enhancedDevice = {
                                ...device,
                                ports: generateRandomPorts(),
                                services: generateRandomServices(),
                                lastSeen: new Date().toLocaleTimeString(),
                                responseTime: Math.floor(Math.random() * 50) + 1 + 'ms'
                            };
                            scanResults.push(enhancedDevice);
                            updateDeviceList();
                        }
                    }
                }
            }, 600);
        }

        function startContinuousMode() {
            if (continuousMode) {
                stopContinuousMode();
                return;
            }
            
            continuousMode = true;
            updateSentinelStatus('MONITOREO CONTINUO');
            
            // Start continuous monitoring
            continuousInterval = setInterval(() => {
                if (!isScanning) {
                    // Simulate device changes
                    simulateNetworkChanges();
                    updateDeviceList();
                }
            }, 10000); // Update every 10 seconds
            
            addStatusLine('üîÑ Modo continuo activado - Monitoreando red...');
        }

        function stopContinuousMode() {
            continuousMode = false;
            if (continuousInterval) {
                clearInterval(continuousInterval);
                continuousInterval = null;
            }
            updateSentinelStatus('LISTO');
            addStatusLine('‚èπÔ∏è Modo continuo desactivado');
        }

        function completeScan() {
            clearInterval(scanInterval);
            isScanning = false;
            
            // Add remaining devices
            deviceDatabase.forEach(device => {
                if (!scanResults.find(d => d.ip === device.ip)) {
                    scanResults.push({...device});
                }
            });
            
            updateScanProgress(100, 'Escaneo completado');
            updateSentinelStatus('COMPLETADO');
            updateDeviceList();
            checkForThreats();
            
            setTimeout(() => {
                document.getElementById('scanProgress').style.display = 'none';
                updateSentinelStatus('LISTO');
                document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
            }, 2000);
        }

        function completeAdvancedScan() {
            clearInterval(scanInterval);
            isScanning = false;
            
            // Add all devices with enhanced info
            deviceDatabase.forEach(device => {
                if (!scanResults.find(d => d.ip === device.ip)) {
                    const enhancedDevice = {
                        ...device,
                        ports: generateRandomPorts(),
                        services: generateRandomServices(),
                        lastSeen: new Date().toLocaleTimeString(),
                        responseTime: Math.floor(Math.random() * 50) + 1 + 'ms',
                        vulnerabilities: device.threat > 5 ? generateVulnerabilities() : []
                    };
                    scanResults.push(enhancedDevice);
                }
            });
            
            updateScanProgress(100, 'Escaneo avanzado completado');
            updateSentinelStatus('AN√ÅLISIS COMPLETO');
            updateDeviceList();
            checkForThreats();
            
            setTimeout(() => {
                document.getElementById('scanProgress').style.display = 'none';
                updateSentinelStatus('LISTO');
                document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
            }, 2000);
        }

        function updateScanProgress(progress, message) {
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = message;
        }

        function updateSentinelStatus(status) {
            document.getElementById('sentinelStatus').textContent = status;
        }

        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            scanResults.forEach(device => {
                const deviceElement = createDeviceElement(device);
                deviceList.appendChild(deviceElement);
            });
            
            document.getElementById('deviceCount').textContent = scanResults.length;
        }

        function createDeviceElement(device) {
            const deviceDiv = document.createElement('div');
            deviceDiv.className = `device-item ${device.threat > 5 ? 'suspicious' : ''}`;
            
            const deviceInfo = document.createElement('div');
            deviceInfo.className = 'device-info';
            
            const deviceIP = document.createElement('div');
            deviceIP.className = 'device-ip';
            deviceIP.textContent = device.ip;
            
            const deviceDetails = document.createElement('div');
            deviceDetails.className = 'device-details';
            
            let detailsText = `MAC: ${device.mac} | ${device.vendor} | ${device.os}`;
            if (device.hostname) detailsText += ` | ${device.hostname}`;
            if (device.responseTime) detailsText += ` | ${device.responseTime}`;
            if (device.ports) detailsText += ` | Puertos: ${device.ports.join(', ')}`;
            
            deviceDetails.textContent = detailsText;
            
            deviceInfo.appendChild(deviceIP);
            deviceInfo.appendChild(deviceDetails);
            
            const deviceStatus = document.createElement('div');
            deviceStatus.className = 'device-status';
            
            const statusIcon = document.createElement('div');
            statusIcon.className = `device-status-icon ${device.threat > 5 ? 'suspicious' : ''}`;
            
            const threatScore = document.createElement('span');
            threatScore.textContent = device.threat > 5 ? `‚ö†Ô∏è ${device.threat}/10` : '‚úÖ Seguro';
            threatScore.style.color = device.threat > 5 ? '#ff4444' : '#00ff00';
            
            deviceStatus.appendChild(statusIcon);
            deviceStatus.appendChild(threatScore);
            
            deviceDiv.appendChild(deviceInfo);
            deviceDiv.appendChild(deviceStatus);
            
            return deviceDiv;
        }

        function checkForThreats() {
            const threats = scanResults.filter(device => device.threat > 5);
            threatLevel = threats.length;
            
            document.getElementById('threatCount').textContent = threatLevel;
            
            if (threatLevel > 0) {
                const threatAlert = document.getElementById('threatAlert');
                const threatMessage = document.getElementById('threatMessage');
                
                if (threatLevel === 1) {
                    threatMessage.textContent = `Dispositivo sospechoso detectado: ${threats[0].ip} (${threats[0].hostname})`;
                } else {
                    threatMessage.textContent = `${threatLevel} dispositivos sospechosos detectados en la red`;
                }
                
                threatAlert.classList.add('show');
                
                // Alert sound simulation
                addStatusLine(`üö® ALERTA: ${threatLevel} amenaza(s) detectada(s)`);
                
                // Integrate with Ae.N.K.I
                const alertMessage = `¬°Alerta de seguridad! He detectado ${threatLevel} dispositivo(s) sospechoso(s) en la red. Se requiere investigaci√≥n inmediata.`;
                addMessage(alertMessage, 'aenki');
                
                if (aenkiAvatar) {
                    aenkiAvatar.speak(alertMessage);
                }
            }
        }

        function simulateNetworkChanges() {
            // Simulate device coming online/offline
            if (Math.random() < 0.3) {
                const randomDevice = deviceDatabase[Math.floor(Math.random() * deviceDatabase.length)];
                const existingDevice = scanResults.find(d => d.ip === randomDevice.ip);
                
                if (existingDevice) {
                    // Update last seen
                    existingDevice.lastSeen = new Date().toLocaleTimeString();
                    existingDevice.responseTime = Math.floor(Math.random() * 50) + 1 + 'ms';
                } else {
                    // Add new device
                    scanResults.push({...randomDevice, lastSeen: new Date().toLocaleTimeString()});
                    addStatusLine(`üì° Nuevo dispositivo detectado: ${randomDevice.ip}`);
                }
            }
        }

        function generateRandomPorts() {
            const commonPorts = [22, 23, 53, 80, 443, 993, 995, 3389, 5900, 8080];
            const numPorts = Math.floor(Math.random() * 4) + 1;
            const ports = [];
            
            for (let i = 0; i < numPorts; i++) {
                ports.push(commonPorts[Math.floor(Math.random() * commonPorts.length)]);
            }
            
            return [...new Set(ports)];
        }

        function generateRandomServices() {
            const services = ['HTTP', 'HTTPS', 'SSH', 'FTP', 'SMTP', 'DNS', 'SNMP', 'RDP'];
            const numServices = Math.floor(Math.random() * 3) + 1;
            const result = [];
            
            for (let i = 0; i < numServices; i++) {
                result.push(services[Math.floor(Math.random() * services.length)]);
            }
            
            return [...new Set(result)];
        }

        function generateVulnerabilities() {
            const vulns = [
                'CVE-2021-44228 (Log4Shell)',
                'CVE-2021-34527 (PrintNightmare)',
                'CVE-2020-1472 (Zerologon)',
                'Weak Password Policy',
                'Outdated Software',
                'Open Ports'
            ];
            
            const numVulns = Math.floor(Math.random() * 3) + 1;
            const result = [];
            
            for (let i = 0; i < numVulns; i++) {
                result.push(vulns[Math.floor(Math.random() * vulns.length)]);
            }
            
            return [...new Set(result)];
        }

        function exportScanResults() {
            if (scanResults.length === 0) {
                addStatusLine('‚ùå No hay resultados para exportar');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `sentinel_scan_${timestamp}.json`;
            
            const exportData = {
                timestamp: new Date().toISOString(),
                scanType: 'Sentinel Network Scan',
                deviceCount: scanResults.length,
                threatCount: threatLevel,
                devices: scanResults
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            addStatusLine(`üìä Resultados exportados: ${filename}`);
        }

        // TalkingHead Avatar Integration
        class AenkiAvatar {
            constructor() {
                this.talkingHead = null;
                this.isInitialized = false;
                this.isLoading = false;
                this.canvas = document.getElementById('talkinghead-canvas');
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.avatar = null;
                this.animationId = null;
                
                this.initializeAvatar();
            }

            async initializeAvatar() {
                if (this.isLoading) return;
                this.isLoading = true;

                try {
                    // Initialize Three.js scene
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(75, this.canvas.width / this.canvas.height, 0.1, 1000);
                    this.renderer = new THREE.WebGLRenderer({ 
                        canvas: this.canvas, 
                        antialias: true, 
                        alpha: true 
                    });
                    
                    this.renderer.setSize(this.canvas.clientWidth, this.canvas.clientHeight);
                    this.renderer.setClearColor(0x000000, 0);
                    
                    // Add lighting
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                    this.scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    this.scene.add(directionalLight);
                    
                    // Create avatar geometry (simplified 3D head)
                    this.createAvatarGeometry();
                    
                    // Position camera
                    this.camera.position.z = 5;
                    
                    // Start animation loop
                    this.animate();
                    
                    this.isInitialized = true;
                    this.isLoading = false;
                    
                    console.log('Ae.N.K.I Avatar initialized successfully');
                    
                } catch (error) {
                    console.error('Error initializing Ae.N.K.I Avatar:', error);
                    this.isLoading = false;
                }
            }

            createAvatarGeometry() {
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0xffd700,
                    shininess: 100,
                    transparent: true,
                    opacity: 0.9
                });
                
                this.avatar = new THREE.Mesh(geometry, material);
                this.scene.add(this.avatar);
                
                // Add eyes
                const eyeGeometry = new THREE.SphereGeometry(0.1, 16, 16);
                const eyeMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
                
                const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
                leftEye.position.set(-0.3, 0.2, 0.8);
                this.avatar.add(leftEye);
                
                const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
                rightEye.position.set(0.3, 0.2, 0.8);
                this.avatar.add(rightEye);
                
                // Add mouth
                const mouthGeometry = new THREE.CylinderGeometry(0.2, 0.2, 0.1, 16);
                const mouthMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
                mouth.position.set(0, -0.3, 0.7);
                mouth.rotation.x = Math.PI / 2;
                this.avatar.add(mouth);
            }

            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                if (this.avatar) {
                    // Gentle floating animation
                    this.avatar.position.y = Math.sin(Date.now() * 0.001) * 0.1;
                    this.avatar.rotation.y += 0.005;
                    
                    // Breathing effect
                    const breathScale = 1 + Math.sin(Date.now() * 0.002) * 0.05;
                    this.avatar.scale.set(breathScale, breathScale, breathScale);
                }
                
                this.renderer.render(this.scene, this.camera);
            }

            speak(text) {
                if (!this.isInitialized) return;
                
                // Add talking animation
                this.startTalkingAnimation();
                
                // Stop animation after estimated speech time
                const estimatedDuration = text.length * 50; // 50ms per character
                setTimeout(() => {
                    this.stopTalkingAnimation();
                }, estimatedDuration);
            }

            startTalkingAnimation() {
                if (!this.avatar) return;
                
                document.getElementById('avatarContainer').classList.add('talking');
                
                // Add mouth movement animation
                this.talkingAnimation = setInterval(() => {
                    if (this.avatar.children[2]) { // mouth
                        this.avatar.children[2].scale.y = 0.5 + Math.random() * 0.5;
                    }
                }, 100);
            }

            stopTalkingAnimation() {
                document.getElementById('avatarContainer').classList.remove('talking');
                
                if (this.talkingAnimation) {
                    clearInterval(this.talkingAnimation);
                    this.talkingAnimation = null;
                }
                
                if (this.avatar && this.avatar.children[2]) {
                    this.avatar.children[2].scale.y = 1;
                }
            }

            resize() {
                if (!this.renderer || !this.camera) return;
                
                const canvas = this.renderer.domElement;
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                
                this.camera.aspect = width / height;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(width, height);
            }

            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                if (this.renderer) {
                    this.renderer.dispose();
                }
            }
        }

        // Variables globales
        let isListening = false;
        let isMuted = false;
        let recognition;
        let synthesis = window.speechSynthesis;
        let avatarTalking = false;
        let aenkiAvatar;

        // Inicializar avatar 3D
        function initializeAenkiAvatar() {
            try {
                aenkiAvatar = new AenkiAvatar();
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    if (aenkiAvatar) {
                        aenkiAvatar.resize();
                    }
                });
                
            } catch (error) {
                console.error('Error initializing 3D avatar:', error);
                // Fallback to 2D avatar
                document.querySelector('.avatar-image').style.display = 'block';
            }
        }

        // Inicializar reconocimiento de voz con mejoras
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'es-ES';
            recognition.maxAlternatives = 5;

            recognition.onstart = function() {
                console.log('Reconocimiento de voz iniciado');
                addStatusLine('üé§ Reconocimiento de voz activado');
            };

            recognition.onresult = function(event) {
                let transcript = '';
                let confidence = 0;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        transcript += result[0].transcript;
                        confidence = result[0].confidence;
                    }
                }
                
                if (transcript.trim()) {
                    addMessage(transcript, 'user');
                    addStatusLine(`üé§ Reconocido: "${transcript}" (${Math.round(confidence * 100)}% confianza)`);
                    processAenkiResponse(transcript);
                }
            };

            recognition.onerror = function(event) {
                console.error('Error de reconocimiento de voz:', event.error);
                addStatusLine(`‚ùå Error de voz: ${event.error}`);
                
                // Reintentar autom√°ticamente en ciertos errores
                if (event.error === 'no-speech' || event.error === 'audio-capture') {
                    setTimeout(() => {
                        if (isListening) {
                            recognition.start();
                        }
                    }, 1000);
                }
            };

            recognition.onend = function() {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceBtn').classList.add('idle');
                stopListeningAnimation();
                addStatusLine('üé§ Reconocimiento de voz detenido');
            };

            // Verificar permisos de micr√≥fono
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    console.log('Permisos de micr√≥fono concedidos');
                    addStatusLine('‚úÖ Micr√≥fono autorizado');
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(function(err) {
                    console.error('Error de permisos de micr√≥fono:', err);
                    addStatusLine('‚ùå Permisos de micr√≥fono denegados');
                });
        } else {
            addStatusLine('‚ùå Reconocimiento de voz no compatible');
        }

        // Generar part√≠culas de fondo
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Funciones de chat
        function addMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                processAenkiResponse(message);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Procesamiento de respuestas de Ae.N.K.I
        function processAenkiResponse(userMessage) {
            const avatar = document.getElementById('avatarContainer');
            avatar.classList.add('talking');
            
            setTimeout(() => {
                let response = getAenkiResponse(userMessage);
                addMessage(response, 'aenki');
                
                // Integrate with 3D avatar
                if (aenkiAvatar) {
                    aenkiAvatar.speak(response);
                }
                
                if (!isMuted) {
                    speak(response);
                }
                
                setTimeout(() => {
                    avatar.classList.remove('talking');
                }, 3000);
            }, 1000);
        }

        function getAenkiResponse(message) {
            const responses = {
                'hola': '¬°Hola! Soy Ae.N.K.I, tu guardian digital avanzado. Mi sistema de inteligencia artificial est√° completamente integrado con el servidor ORBIX y el scanner Sentinel. ¬øC√≥mo puedo ayudarte hoy?',
                'estado': 'Todos los sistemas est√°n operativos al 100%. Servidor Hetzner en l√≠nea, m√≥dulos de seguridad Sentinel activos, y mi avatar 3D funcionando perfectamente.',
                'servidor': 'El servidor Hetzner est√° funcionando √≥ptimamente. IP: 178.156.182.125. Todos los servicios est√°n activos y monitoreando en tiempo real.',
                'seguridad': 'Ejecutando an√°lisis de seguridad completo con mi sistema de IA avanzado. Sentinel est√° monitoreando la red continuamente. No se detectaron amenazas cr√≠ticas.',
                'ayuda': 'Puedo ayudarte con monitoreo avanzado del servidor, an√°lisis de seguridad con IA, escaneo de red con Sentinel, sincronizaci√≥n de archivos, diagn√≥sticos del sistema, y control de mi avatar 3D. ¬øQu√© necesitas?',
                'orbix': 'ORBIX es nuestro sistema de defensa de IA de pr√≥xima generaci√≥n. Incluye m√≥dulos de seguridad avanzados, monitoreo en tiempo real, an√°lisis predictivo de amenazas, scanner Sentinel, y mi avatar 3D interactivo.',
                'sentinel': 'Sentinel es mi m√≥dulo de escaneo de red y vigilancia autom√°tica con IA. Est√° monitoreando continuamente el sistema usando algoritmos de aprendizaje autom√°tico para detectar anomal√≠as, dispositivos sospechosos y amenazas.',
                'avatar': 'Mi avatar 3D utiliza tecnolog√≠a TalkingHead avanzada con Three.js. Puedo expresar emociones, sincronizar labios con el habla, y responder visualmente a las interacciones.',
                'escanear': 'Iniciando escaneo de red con Sentinel. Detectar√© todos los dispositivos conectados, analizar√© amenazas potenciales, y te alertar√© sobre cualquier actividad sospechosa.',
                'red': 'La red est√° siendo monitoreada por Sentinel. Puedo realizar escaneos b√°sicos, avanzados, o activar el modo de monitoreo continuo para vigilancia 24/7.',
                'default': 'Interesante pregunta. Mi sistema de IA est√° procesando esa informaci√≥n para brindarte la mejor respuesta posible. ¬øPodr√≠as ser m√°s espec√≠fico sobre lo que buscas?'
            };

            const lowerMessage = message.toLowerCase();
            for (let key in responses) {
                if (lowerMessage.includes(key)) {
                    return responses[key];
                }
            }
            return responses['default'];
        }

        // Funciones de voz mejoradas
        function speak(text) {
            if (!isMuted && synthesis) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 0.8;
                synthesis.speak(utterance);
            }
        }

        function toggleVoice() {
            if (!recognition) {
                alert('El reconocimiento de voz no est√° disponible en este navegador.');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceBtn').classList.add('idle');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.remove('idle');
                document.getElementById('voiceBtn').classList.add('listening');
            }
        }

        function speakWelcome() {
            const welcomeMessage = "¬°Bienvenido al sistema ORBIX! Soy Ae.N.K.I, tu asistente de inteligencia artificial. Tengo integrado el sistema Sentinel para monitoreo de red y detecci√≥n de amenazas. ¬øEn qu√© puedo asistirte?";
            addMessage(welcomeMessage, 'aenki');
            speak(welcomeMessage);
        }

        function muteToggle() {
            isMuted = !isMuted;
            const muteBtn = document.querySelector('.voice-controls button:last-child');
            muteBtn.textContent = isMuted ? 'üîä' : 'üîá';
            addStatusLine(isMuted ? 'üîá Audio silenciado' : 'üîä Audio activado');
        }

        // Funciones del panel de control
        function exploreServer() {
            addStatusLine('üîç Explorando servidor Hetzner...');
            setTimeout(() => {
                addStatusLine('üìÅ Estructura del servidor analizada');
                addStatusLine('‚úÖ Acceso completo al sistema de archivos');
                addStatusLine('üìä Uso de disco: 45% | RAM: 32% | CPU: 12%');
            }, 2000);
        }

        function checkSystemHealth() {
            addStatusLine('‚ö° Verificando salud del sistema...');
            setTimeout(() => {
                addStatusLine('üü¢ CPU: √ìptimo (12% uso)');
                addStatusLine('üü¢ Memoria: Saludable (32% uso)');
                addStatusLine('üü¢ Disco: Buen estado (45% uso)');
                addStatusLine('üü¢ Red: Conexi√≥n estable');
                addStatusLine('üü¢ Servicios: Todos activos');
                addStatusLine('‚úÖ Sistema en perfecto estado');
            }, 3000);
        }

        function runSecurityScan() {
            addStatusLine('üîí Iniciando an√°lisis de seguridad...');
            setTimeout(() => {
                addStatusLine('üõ°Ô∏è Firewall: Activo y configurado');
                addStatusLine('üîê SSL/TLS: Certificados v√°lidos');
                addStatusLine('üîë Autenticaci√≥n: M√©todos seguros');
                addStatusLine('üö´ Malware: No detectado');
                addStatusLine('‚ö†Ô∏è Actualizaciones: 2 disponibles');
                addStatusLine('‚úÖ Seguridad: Nivel ALTO');
            }, 4000);
        }

        function showStats() {
            addStatusLine('üìä Recopilando estad√≠sticas...');
            setTimeout(() => {
                addStatusLine('üìà Uptime: 99.9%');
                addStatusLine('üìä Tr√°fico: 1.2TB/mes');
                addStatusLine('üîó Conexiones: 45 activas');
                addStatusLine('‚ö° Respuesta promedio: 12ms');
                addStatusLine('üíæ Backups: 15 completados');
                addStatusLine('üì± Dispositivos: ' + (scanResults.length || 'No escaneados'));
            }, 2000);
        }

        function syncWithLocal() {
            addStatusLine('üîÑ Sincronizando con repositorio local...');
            setTimeout(() => {
                addStatusLine('üì• Descargando cambios...');
                addStatusLine('üì§ Subiendo actualizaciones...');
                addStatusLine('‚úÖ Sincronizaci√≥n completada');
                addStatusLine('üîÑ 15 archivos actualizados');
            }, 3000);
        }

        function showAlerts() {
            addStatusLine('üö® Verificando alertas del sistema...');
            setTimeout(() => {
                addStatusLine('‚ö†Ô∏è Alerta: Uso de CPU pico a las 14:30');
                addStatusLine('üìß Notificaci√≥n: Backup programado en 2 horas');
                addStatusLine('üîî Recordatorio: Renovar certificado SSL en 30 d√≠as');
                addStatusLine('üõ°Ô∏è Sentinel: ' + (threatLevel > 0 ? threatLevel + ' amenazas detectadas' : 'No hay amenazas'));
            }, 2000);
        }

        // Funci√≥n auxiliar para agregar l√≠neas al display de estado
        function addStatusLine(message) {
            const statusDisplay = document.getElementById('statusDisplay');
            const statusLine = document.createElement('div');
            statusLine.className = 'status-line';
            statusLine.style.animationDelay = '0s';
            statusLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusDisplay.appendChild(statusLine);
            statusDisplay.scrollTop = statusDisplay.scrollHeight;
        }

        // Avatar Editor Functions
        function toggleAvatarEditor() {
            const editor = document.getElementById('avatarEditor');
            editor.classList.toggle('open');
        }

        function updateAvatarGeometry() {
            const headSize = document.getElementById('headSize').value;
            if (aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.scale.set(headSize, headSize, headSize);
            }
        }

        function updateAvatarPosition() {
            const posX = document.getElementById('positionX').value;
            const posY = document.getElementById('positionY').value;
            if (aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.position.x = posX;
                aenkiAvatar.avatar.position.y = posY;
            }
        }

        function updateAvatarRotation() {
            const rotation = document.getElementById('rotation').value;
            if (aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.rotation.z = (rotation * Math.PI) / 180;
            }
        }

        function updateAvatarColor() {
            const mainColor = document.getElementById('mainColor').value;
            const eyeColor = document.getElementById('eyeColor').value;
            
            if (aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.material.color.setHex(mainColor.replace('#', '0x'));
                
                // Update eye colors
                if (aenkiAvatar.avatar.children[0]) {
                    aenkiAvatar.avatar.children[0].material.color.setHex(eyeColor.replace('#', '0x'));
                }
                if (aenkiAvatar.avatar.children[1]) {
                    aenkiAvatar.avatar.children[1].material.color.setHex(eyeColor.replace('#', '0x'));
                }
            }
        }

        function updateAvatarMaterial() {
            const shininess = document.getElementById('shininess').value;
            const opacity = document.getElementById('opacity').value;
            
            if (aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.material.shininess = shininess;
                aenkiAvatar.avatar.material.opacity = opacity;
            }
        }

        function playAvatarAnimation(animationType) {
            if (!aenkiAvatar || !aenkiAvatar.avatar) return;
            
            const avatar = aenkiAvatar.avatar;
            
            switch (animationType) {
                case 'wave':
                    // Simple wave animation
                    let waveCount = 0;
                    const waveInterval = setInterval(() => {
                        avatar.rotation.z = Math.sin(waveCount * 0.5) * 0.3;
                        waveCount++;
                        if (waveCount > 10) {
                            clearInterval(waveInterval);
                            avatar.rotation.z = 0;
                        }
                    }, 100);
                    break;
                    
                case 'nod':
                    // Nodding animation
                    let nodCount = 0;
                    const nodInterval = setInterval(() => {
                        avatar.rotation.x = Math.sin(nodCount * 0.8) * 0.2;
                        nodCount++;
                        if (nodCount > 8) {
                            clearInterval(nodInterval);
                            avatar.rotation.x = 0;
                        }
                    }, 100);
                    break;
                    
                case 'shake':
                    // Head shake animation
                    let shakeCount = 0;
                    const shakeInterval = setInterval(() => {
                        avatar.rotation.y = Math.sin(shakeCount * 1.2) * 0.3;
                        shakeCount++;
                        if (shakeCount > 10) {
                            clearInterval(shakeInterval);
                            avatar.rotation.y = 0;
                        }
                    }, 80);
                    break;
                    
                case 'think':
                    // Thinking animation
                    avatar.rotation.x = -0.2;
                    setTimeout(() => {
                        avatar.rotation.x = 0;
                    }, 2000);
                    break;
                    
                case 'happy':
                    // Happy bounce animation
                    let bounceCount = 0;
                    const bounceInterval = setInterval(() => {
                        avatar.position.y = Math.sin(bounceCount * 0.8) * 0.3;
                        bounceCount++;
                        if (bounceCount > 15) {
                            clearInterval(bounceInterval);
                            avatar.position.y = 0;
                        }
                    }, 100);
                    break;
                    
                case 'alert':
                    // Alert animation with color change
                    const originalColor = avatar.material.color.getHex();
                    avatar.material.color.setHex(0xff4444);
                    setTimeout(() => {
                        avatar.material.color.setHex(originalColor);
                    }, 1000);
                    break;
            }
        }

        function loadAvatarPreset(presetName) {
            const presets = {
                'guardian': {
                    color: '#ffd700',
                    eyeColor: '#000000',
                    shininess: 100,
                    opacity: 0.9
                },
                'sentinel': {
                    color: '#00ff00',
                    eyeColor: '#ffffff',
                    shininess: 150,
                    opacity: 0.8
                },
                'cyber': {
                    color: '#ff00ff',
                    eyeColor: '#00ffff',
                    shininess: 200,
                    opacity: 0.7
                },
                'classic': {
                    color: '#0000ff',
                    eyeColor: '#ffffff',
                    shininess: 80,
                    opacity: 1.0
                }
            };
            
            const preset = presets[presetName];
            if (preset && aenkiAvatar && aenkiAvatar.avatar) {
                aenkiAvatar.avatar.material.color.setHex(preset.color.replace('#', '0x'));
                aenkiAvatar.avatar.material.shininess = preset.shininess;
                aenkiAvatar.avatar.material.opacity = preset.opacity;
                
                // Update eye colors
                if (aenkiAvatar.avatar.children[0]) {
                    aenkiAvatar.avatar.children[0].material.color.setHex(preset.eyeColor.replace('#', '0x'));
                }
                if (aenkiAvatar.avatar.children[1]) {
                    aenkiAvatar.avatar.children[1].material.color.setHex(preset.eyeColor.replace('#', '0x'));
                }
                
                // Update UI controls
                document.getElementById('mainColor').value = preset.color;
                document.getElementById('eyeColor').value = preset.eyeColor;
                document.getElementById('shininess').value = preset.shininess;
                document.getElementById('opacity').value = preset.opacity;
                
                addStatusLine(`üé® Preset '${presetName}' cargado`);
            }
        }

        function saveAvatarConfig() {
            const config = {
                headSize: document.getElementById('headSize').value,
                positionX: document.getElementById('positionX').value,
                positionY: document.getElementById('positionY').value,
                rotation: document.getElementById('rotation').value,
                mainColor: document.getElementById('mainColor').value,
                eyeColor: document.getElementById('eyeColor').value,
                shininess: document.getElementById('shininess').value,
                opacity: document.getElementById('opacity').value,
                speechRate: document.getElementById('speechRate').value,
                speechPitch: document.getElementById('speechPitch').value,
                speechVolume: document.getElementById('speechVolume').value
            };
            
            localStorage.setItem('aenkiAvatarConfig', JSON.stringify(config));
            addStatusLine('üíæ Configuraci√≥n del avatar guardada');
        }

        function loadAvatarConfig() {
            const config = localStorage.getItem('aenkiAvatarConfig');
            if (config) {
                const savedConfig = JSON.parse(config);
                
                // Update UI controls
                Object.keys(savedConfig).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = savedConfig[key];
                    }
                });
                
                // Apply settings
                updateAvatarGeometry();
                updateAvatarPosition();
                updateAvatarRotation();
                updateAvatarColor();
                updateAvatarMaterial();
                updateSpeechSettings();
                
                addStatusLine('üìÅ Configuraci√≥n del avatar cargada');
            } else {
                addStatusLine('‚ùå No se encontr√≥ configuraci√≥n guardada');
            }
        }

        function resetAvatarToDefault() {
            // Reset UI controls to default values
            document.getElementById('headSize').value = 1;
            document.getElementById('positionX').value = 0;
            document.getElementById('positionY').value = 0;
            document.getElementById('rotation').value = 0;
            document.getElementById('mainColor').value = '#ffd700';
            document.getElementById('eyeColor').value = '#000000';
            document.getElementById('shininess').value = 100;
            document.getElementById('opacity').value = 0.9;
            document.getElementById('speechRate').value = 0.9;
            document.getElementById('speechPitch').value = 1.1;
            document.getElementById('speechVolume').value = 0.8;
            
            // Apply default settings
            updateAvatarGeometry();
            updateAvatarPosition();
            updateAvatarRotation();
            updateAvatarColor();
            updateAvatarMaterial();
            updateSpeechSettings();
            
            addStatusLine('üîÑ Avatar reiniciado a configuraci√≥n por defecto');
        }

        function updateSpeechSettings() {
            const speechRate = document.getElementById('speechRate').value;
            const speechPitch = document.getElementById('speechPitch').value;
            const speechVolume = document.getElementById('speechVolume').value;
            
            // Store settings for speech synthesis
            window.aenkiSpeechSettings = {
                rate: parseFloat(speechRate),
                pitch: parseFloat(speechPitch),
                volume: parseFloat(speechVolume)
            };
        }

        // Enhanced Avatar Image Integration
        function initializeAvatarImage() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            // Set the avatar image source
            avatarImage.src = 'https://sistemasorbix.com/assets/img/aenki-avatar.png';
            
            // Add loading and error handlers
            avatarImage.onload = function() {
                console.log('Avatar Ae.N.K.I cargado exitosamente');
                avatarContainer.classList.add('loaded');
                addStatusLine('üñºÔ∏è Avatar Ae.N.K.I cargado desde servidor');
                
                // Start idle animation
                startIdleAnimation();
            };
            
            avatarImage.onerror = function() {
                console.error('Error cargando avatar desde servidor');
                avatarImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgdmlld0JveD0iMCAwIDMwMCAzMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMzAwIiBmaWxsPSIjMUEyMzMwIiByeD0iMTUiLz4KPGNpcmNsZSBjeD0iMTUwIiBjeT0iMTMwIiByPSI2MCIgZmlsbD0iI0ZGRDcwMCIvPgo8Y2lyY2xlIGN4PSIxMzAiIGN5PSIxMTAiIHI9IjgiIGZpbGw9IiMwMDAwMDAiLz4KPGNpcmNsZSBjeD0iMTcwIiBjeT0iMTEwIiByPSI4IiBmaWxsPSIjMDAwMDAwIi8+CjxlbGxpcHNlIGN4PSIxNTAiIGN5PSIxNTAiIHJ4PSIxNSIgcnk9IjgiIGZpbGw9IiMwMDAwMDAiLz4KPHRleHQgeD0iMTUwIiB5PSIyNDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNGRkQ3MDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiPkFlLk4uSy5JPC90ZXh0Pgo8L3N2Zz4=';
                addStatusLine('‚ö†Ô∏è Usando avatar de respaldo - Verificar conexi√≥n');
            };
        }

        // Avatar Animation Functions
        function startIdleAnimation() {
            const avatarImage = document.getElementById('avatarImage');
            
            // Breathing effect
            avatarImage.style.animation = 'avatarBreathe 4s ease-in-out infinite';
            
            // Subtle floating
            setTimeout(() => {
                avatarImage.style.animation += ', avatarFloat 6s ease-in-out infinite';
            }, 1000);
        }

        function startTalkingAnimation() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            avatarContainer.classList.add('talking');
            avatarImage.style.animation = 'avatarTalk 0.3s ease-in-out infinite, avatarGlow 0.5s ease-in-out infinite';
            
            // Add talking particles
            createTalkingParticles();
        }

        function stopTalkingAnimation() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            avatarContainer.classList.remove('talking');
            avatarImage.style.animation = 'avatarBreathe 4s ease-in-out infinite, avatarFloat 6s ease-in-out infinite';
            
            // Remove talking particles
            removeTalkingParticles();
        }

        function startListeningAnimation() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            avatarContainer.classList.add('listening');
            avatarImage.style.animation = 'avatarListen 1s ease-in-out infinite, avatarPulse 2s ease-in-out infinite';
            
            // Add listening wave effect
            createListeningWaves();
        }

        function stopListeningAnimation() {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            avatarContainer.classList.remove('listening');
            avatarImage.style.animation = 'avatarBreathe 4s ease-in-out infinite, avatarFloat 6s ease-in-out infinite';
            
            // Remove listening waves
            removeListeningWaves();
        }

        function playEmotionAnimation(emotion) {
            const avatarImage = document.getElementById('avatarImage');
            const avatarContainer = document.getElementById('avatarContainer');
            
            // Remove existing emotion classes
            avatarContainer.classList.remove('happy', 'thinking', 'alert', 'processing', 'scanning');
            
            // Add new emotion class
            avatarContainer.classList.add(emotion);
            
            switch(emotion) {
                case 'happy':
                    avatarImage.style.animation = 'avatarHappy 0.8s ease-in-out 3, avatarBounce 0.5s ease-in-out 6';
                    createHappyParticles();
                    break;
                case 'thinking':
                    avatarImage.style.animation = 'avatarThink 2s ease-in-out 3';
                    createThinkingEffect();
                    break;
                case 'alert':
                    avatarImage.style.animation = 'avatarAlert 0.3s ease-in-out 8';
                    createAlertEffect();
                    break;
                case 'processing':
                    avatarImage.style.animation = 'avatarProcess 1s linear infinite';
                    createProcessingEffect();
                    break;
                case 'scanning':
                    avatarImage.style.animation = 'avatarScan 0.5s ease-in-out infinite';
                    createScanningEffect();
                    break;
            }
            
            // Return to idle after animation
            setTimeout(() => {
                avatarContainer.classList.remove(emotion);
                startIdleAnimation();
                removeAllEffects();
            }, 5000);
        }

        // Particle Effects for Avatar
        function createTalkingParticles() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'talking-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 2 + 's';
                avatarContainer.appendChild(particle);
            }
        }

        function removeTalkingParticles() {
            const particles = document.querySelectorAll('.talking-particle');
            particles.forEach(particle => particle.remove());
        }

        function createListeningWaves() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            for (let i = 0; i < 4; i++) {
                const wave = document.createElement('div');
                wave.className = 'listening-wave';
                wave.style.animationDelay = i * 0.3 + 's';
                avatarContainer.appendChild(wave);
            }
        }

        function removeListeningWaves() {
            const waves = document.querySelectorAll('.listening-wave');
            waves.forEach(wave => wave.remove());
        }

        function createHappyParticles() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'happy-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 2 + 's';
                particle.innerHTML = ['‚ú®', 'üí´', '‚≠ê', 'üåü'][Math.floor(Math.random() * 4)];
                avatarContainer.appendChild(particle);
            }
        }

        function createThinkingEffect() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            const thinkBubble = document.createElement('div');
            thinkBubble.className = 'thinking-bubble';
            thinkBubble.innerHTML = 'üí≠';
            avatarContainer.appendChild(thinkBubble);
        }

        function createAlertEffect() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            const alertRing = document.createElement('div');
            alertRing.className = 'alert-ring';
            avatarContainer.appendChild(alertRing);
        }

        function createProcessingEffect() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            const processingRing = document.createElement('div');
            processingRing.className = 'processing-ring';
            avatarContainer.appendChild(processingRing);
        }

        function createScanningEffect() {
            const avatarContainer = document.getElementById('avatarContainer');
            
            const scanLine = document.createElement('div');
            scanLine.className = 'scanning-line';
            avatarContainer.appendChild(scanLine);
        }

        function removeAllEffects() {
            const effects = document.querySelectorAll('.talking-particle, .listening-wave, .happy-particle, .thinking-bubble, .alert-ring, .processing-ring, .scanning-line');
            effects.forEach(effect => effect.remove());
        }

        // Enhanced Speech Function with Avatar Animation
        function speak(text) {
            if (!isMuted && synthesis) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                
                // Use saved speech settings
                if (window.aenkiSpeechSettings) {
                    utterance.rate = window.aenkiSpeechSettings.rate;
                    utterance.pitch = window.aenkiSpeechSettings.pitch;
                    utterance.volume = window.aenkiSpeechSettings.volume;
                } else {
                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;
                    utterance.volume = 0.8;
                }
                
                utterance.onstart = function() {
                    startTalkingAnimation();
                };
                
                utterance.onend = function() {
                    stopTalkingAnimation();
                };
                
                synthesis.speak(utterance);
            }
        }

        // Enhanced Voice Recognition with Avatar Animation
        function toggleVoice() {
            if (!recognition) {
                alert('El reconocimiento de voz no est√° disponible en este navegador.');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceBtn').classList.add('idle');
                stopListeningAnimation();
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.remove('idle');
                document.getElementById('voiceBtn').classList.add('listening');
                startListeningAnimation();
            }
        }

        // Enhanced Response Processing with Emotions
        function processAenkiResponse(userMessage) {
            // Show processing animation
            playEmotionAnimation('processing');
            
            setTimeout(() => {
                let response = getAenkiResponse(userMessage);
                let emotion = getResponseEmotion(userMessage, response);
                
                addMessage(response, 'aenki');
                
                // Play emotion animation
                playEmotionAnimation(emotion);
                
                if (!isMuted) {
                    speak(response);
                }
                
                // Add contextual status
                addStatusLine(`ü§ñ Ae.N.K.I respondi√≥ con emoci√≥n: ${emotion}`);
                
            }, 1000);
        }

        function getResponseEmotion(userMessage, response) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('gracias') || lowerMessage.includes('excelente') || lowerMessage.includes('perfecto')) {
                return 'happy';
            } else if (lowerMessage.includes('ayuda') || lowerMessage.includes('como') || lowerMessage.includes('que es')) {
                return 'thinking';
            } else if (lowerMessage.includes('alerta') || lowerMessage.includes('problema') || lowerMessage.includes('error')) {
                return 'alert';
            } else if (lowerMessage.includes('escanear') || lowerMessage.includes('sentinel') || lowerMessage.includes('red')) {
                return 'scanning';
            } else {
                return 'thinking';
            }
        }

        // Initialize Avatar on Load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize avatar image
            initializeAvatarImage();
            
            // Initialize speech settings
            updateSpeechSettings();
            
            // Load saved avatar configuration
            loadAvatarConfig();
            
            // Initialize other systems
            initializeSystem();
            createParticles();
            
            setTimeout(() => {
                speakWelcome();
            }, 2000);
        });
    </script>
</body>
</html>